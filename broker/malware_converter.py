import json
import logging
import time

import subprocess
import argparse
import json
import xmltodict

malware_ports = {
                        1080: "mydoom",
                        2283: "dumaru",
                        2535: "beagle",
                        2745: "beagle",
                        3127: "mydoom",
                        3128: "mydoom",
                        3410: "backdoor",
                        5554: "sasser",
                        8866: "beagle",
                        9898: "dabber",
                        10000: "dumaru",
                        10080: "mydoom",
                        12345: "netbus",
                        17300: "kuang2",
                        27374: "subseven",
                        65506: "phatbot"
                    }


def malware_converter(filename):

    #logging.warning("ENTROU NO FICHEIRO")

    f = open(filename)
    content = f.read()
    f.close()

    data = xmltodict.parse(content)

    #print(json.dumps(data,indent = 2))

    output_json = dict()


    # ------------------------ adding host ports------------------------- #
    if "host" in data["nmaprun"]:
        if "ports" in data["nmaprun"]["host"]:
            if "port" in data["nmaprun"]["host"]["ports"]:
                if isinstance(data["nmaprun"]["host"]["ports"]["port"], list):
                    output_json["ports"] = list()

                    for l in data["nmaprun"]["host"]["ports"]["port"]:
                        element = dict()
                        element["protocol"] = l["@protocol"] if ("@protocol" in l) else None
                        element["id"] = l["@portid"] if ("@portid" in l) else None
                        if "state" in l:
                            element["state"] = l["state"]["@state"] if ("@state" in l["state"]) else None
                        if "service" in l:
                            element["name"] = l["service"]["@name"] if ("@name" in l["service"]) else None

                        output_json["ports"].append(element)

                else:
                    output_json["ports"] = dict()

                    output_json["ports"]["protocol"] = data["nmaprun"]["host"]["ports"]["port"]["@protocol"] if ("@protocol" in data["nmaprun"]["host"]["ports"]["port"]) else None
                    output_json["ports"]["id"] = data["nmaprun"]["host"]["ports"]["port"]["@portid"] if ("@portid" in data["nmaprun"]["host"]["ports"]["port"]) else None
                    output_json["ports"]["name"] = data["nmaprun"]["host"]["ports"]["port"]["service"]["@name"] if ("@name" in data["nmaprun"]["host"]["ports"]["port"]["service"]) else None
                    output_json["ports"]["state"] = data["nmaprun"]["host"]["ports"]["port"]["state"]["@state"] if ("@state" in data["nmaprun"]["host"]["ports"]["port"]["state"]) else None
                    logging.warning(output_json["ports"]["state"])

    output_json["TOOL"] = "nmap_malware"


    #print(json.dumps(output_json, indent = 2))
    

    if "ports" in output_json:
        
        malware_final = list()

        for port in output_json["ports"]:
            #print(port['name'])

            list_element = dict()

            if port["state"] == "open":

                list_element["port"] = port["id"]
                list_element["malware"] = malware_ports[int(port["id"])]

                malware_final.append(list_element)

        output_final={"status":"UP", "TOOL":"nmap_malware", "ports":malware_final }
    
    else:
        output_final = {"status": "nothing found", "TOOL":"nmap_malware" }

    #logging.warning("SAIU DO FICHEIRO")
    #logging.warning(json.dumps(output_final, indent=2))

    return output_final

